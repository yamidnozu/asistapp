import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:asistapp/main.dart' as app;

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();

  // ============================================================================
  // FUNCIONES AUXILIARES
  // ============================================================================

  /// Limpia el estado de autenticaciÃ³n antes de cada test
  Future<void> clearAuthState() async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.remove('accessToken');
    await prefs.remove('refreshToken');
    await prefs.remove('user');
    await prefs.remove('selectedInstitutionId');
  }

  /// Login general - Busca campos por tipo (mÃ¡s robusto)
  Future<void> loginAs(
    WidgetTester tester,
    String email,
    String password,
  ) async {
    print('\n[LOGIN] Iniciando sesiÃ³n con: $email');
    
    // Buscar por tipo de widget (mÃ¡s robusto en desktop)
    final textFields = find.byType(TextFormField);
    
    if (textFields.evaluate().isEmpty) {
      throw Exception('No se encontraron campos de texto en la pantalla de login');
    }

    // Ingresar email en primer campo
    await tester.enterText(textFields.at(0), email);
    await tester.pumpAndSettle(const Duration(milliseconds: 500));

    // Ingresar contraseÃ±a en segundo campo
    await tester.enterText(textFields.at(1), password);
    await tester.pumpAndSettle(const Duration(milliseconds: 500));

    // Presionar botÃ³n de login
    final buttons = find.byType(ElevatedButton);
    if (buttons.evaluate().isEmpty) {
      throw Exception('No se encontrÃ³ botÃ³n de login');
    }

    await tester.tap(buttons.first);
    await tester.pumpAndSettle(const Duration(seconds: 5));

    print('âœ… Login completado');
  }

  /// Logout general
  Future<void> performLogout(WidgetTester tester) async {
    print('\n[LOGOUT] Cerrando sesiÃ³n...');

    // Buscar botÃ³n de logout (puede estar en AppBar o menÃº)
    final logoutButton = find.byIcon(Icons.logout);
    
    if (logoutButton.evaluate().isNotEmpty) {
      await tester.tap(logoutButton.first);
      await tester.pumpAndSettle(const Duration(seconds: 3));
    } else {
      print('â„¹ï¸ BotÃ³n de logout no encontrado, continuando...');
    }

    print('âœ… Logout completado');
  }

  /// Navegar a una secciÃ³n usando el texto del botÃ³n
  Future<void> navigateTo(WidgetTester tester, String sectionName) async {
    print('\n[NAVIGATION] Navegando a: $sectionName');
    
    final navButton = find.text(sectionName);
    if (navButton.evaluate().isEmpty) {
      throw Exception('No se encontrÃ³ botÃ³n para: $sectionName');
    }

    await tester.tap(navButton.first);
    await tester.pumpAndSettle(const Duration(seconds: 2));

    print('âœ… NavegaciÃ³n completada');
  }

  /// Crear una instituciÃ³n
  Future<void> createInstitution(
    WidgetTester tester, {
    required String nombre,
    required String codigo,
    required String email,
  }) async {
    print('\n[CREATE] Creando instituciÃ³n: $nombre');

    // Presionar FAB
    final fabButton = find.byType(FloatingActionButton);
    if (fabButton.evaluate().isNotEmpty) {
      await tester.tap(fabButton.first);
      await tester.pumpAndSettle();
    }

    // Llenar formulario
    final textFields = find.byType(TextFormField);
    if (textFields.evaluate().length >= 3) {
      await tester.enterText(textFields.at(0), nombre);
      await tester.pumpAndSettle(const Duration(milliseconds: 300));
      await tester.enterText(textFields.at(1), codigo);
      await tester.pumpAndSettle(const Duration(milliseconds: 300));
      await tester.enterText(textFields.at(2), email);
      await tester.pumpAndSettle(const Duration(milliseconds: 300));
    }

    // Guardar
    final buttons = find.byType(ElevatedButton);
    if (buttons.evaluate().isNotEmpty) {
      await tester.tap(buttons.first);
      await tester.pumpAndSettle(const Duration(seconds: 3));
    }

    // Verificar
    expect(find.text(nombre), findsWidgets, reason: 'InstituciÃ³n no aparece en lista');
    print('âœ… InstituciÃ³n creada exitosamente');
  }

  /// Actualizar una instituciÃ³n
  Future<void> updateInstitution(
    WidgetTester tester, {
    required String originalName,
    required String newName,
  }) async {
    print('\n[UPDATE] Actualizando instituciÃ³n: $originalName -> $newName');

    // Buscar menÃº de opciones
    final moreIcons = find.byIcon(Icons.more_vert);
    if (moreIcons.evaluate().isEmpty) {
      print('âš ï¸ MenÃº de opciones no encontrado, omitiendo actualizaciÃ³n');
      return;
    }

    await tester.tap(moreIcons.first);
    await tester.pumpAndSettle();

    // Buscar opciÃ³n Editar
    final editOption = find.text('Editar');
    if (editOption.evaluate().isNotEmpty) {
      await tester.tap(editOption.first);
      await tester.pumpAndSettle();

      // Modificar nombre
      final textFields = find.byType(TextFormField);
      if (textFields.evaluate().isNotEmpty) {
        // Seleccionar todo y reemplazar
        await tester.tap(textFields.at(0));
        await tester.pumpAndSettle(const Duration(milliseconds: 200));
        
        // Limpiar campo
        await tester.enterText(textFields.at(0), newName);
        await tester.pumpAndSettle(const Duration(milliseconds: 300));
      }

      // Guardar
      final saveButton = find.byType(ElevatedButton);
      if (saveButton.evaluate().isNotEmpty) {
        await tester.tap(saveButton.first);
        await tester.pumpAndSettle(const Duration(seconds: 3));
      }

      // Verificar
      expect(find.text(newName), findsWidgets);
      print('âœ… InstituciÃ³n actualizada exitosamente');
    }
  }

  /// Eliminar una instituciÃ³n
  Future<void> deleteInstitution(
    WidgetTester tester, {
    required String institutionName,
  }) async {
    print('\n[DELETE] Eliminando instituciÃ³n: $institutionName');

    // Buscar menÃº de opciones
    final moreIcons = find.byIcon(Icons.more_vert);
    if (moreIcons.evaluate().isEmpty) {
      print('âš ï¸ MenÃº de opciones no encontrado, omitiendo eliminaciÃ³n');
      return;
    }

    await tester.tap(moreIcons.first);
    await tester.pumpAndSettle();

    // Buscar opciÃ³n Eliminar
    final deleteOption = find.text('Eliminar');
    if (deleteOption.evaluate().isNotEmpty) {
      await tester.tap(deleteOption.first);
      await tester.pumpAndSettle();

      // Confirmar en diÃ¡logo
      final confirmButton = find.byType(TextButton);
      if (confirmButton.evaluate().length >= 2) {
        // Presionar el botÃ³n de confirmar (generalmente es el Ãºltimo)
        await tester.tap(confirmButton.last);
        await tester.pumpAndSettle(const Duration(seconds: 3));
      }

      // Verificar que fue eliminada
      expect(find.text(institutionName), findsNothing);
      print('âœ… InstituciÃ³n eliminada exitosamente');
    }
  }

  /// Crear un usuario (profesor o estudiante)
  Future<void> createUser(
    WidgetTester tester, {
    required String nombres,
    required String apellidos,
    required String email,
    String? identificacion,
    String? responsable,
  }) async {
    print('\n[CREATE] Creando usuario: $nombres $apellidos');

    // Presionar FAB
    final fabButton = find.byType(FloatingActionButton);
    if (fabButton.evaluate().isNotEmpty) {
      await tester.tap(fabButton.first);
      await tester.pumpAndSettle();
    }

    // Llenar formulario
    final textFields = find.byType(TextFormField);
    int fieldIndex = 0;

    if (textFields.evaluate().length > fieldIndex) {
      await tester.enterText(textFields.at(fieldIndex), nombres);
      fieldIndex++;
      await tester.pumpAndSettle(const Duration(milliseconds: 300));
    }

    if (textFields.evaluate().length > fieldIndex) {
      await tester.enterText(textFields.at(fieldIndex), apellidos);
      fieldIndex++;
      await tester.pumpAndSettle(const Duration(milliseconds: 300));
    }

    if (textFields.evaluate().length > fieldIndex) {
      await tester.enterText(textFields.at(fieldIndex), email);
      fieldIndex++;
      await tester.pumpAndSettle(const Duration(milliseconds: 300));
    }

    if (identificacion != null && textFields.evaluate().length > fieldIndex) {
      await tester.enterText(textFields.at(fieldIndex), identificacion);
      fieldIndex++;
      await tester.pumpAndSettle(const Duration(milliseconds: 300));
    }

    if (responsable != null && textFields.evaluate().length > fieldIndex) {
      await tester.enterText(textFields.at(fieldIndex), responsable);
      await tester.pumpAndSettle(const Duration(milliseconds: 300));
    }

    // Guardar
    final buttons = find.byType(ElevatedButton);
    if (buttons.evaluate().isNotEmpty) {
      await tester.tap(buttons.first);
      await tester.pumpAndSettle(const Duration(seconds: 3));
    }

    // Verificar
    expect(find.text(email), findsWidgets, reason: 'Usuario no aparece en lista');
    print('âœ… Usuario creado exitosamente');
  }

  /// Eliminar un usuario
  Future<void> deleteUser(
    WidgetTester tester, {
    required String email,
  }) async {
    print('\n[DELETE] Eliminando usuario: $email');

    // Buscar menÃº de opciones
    final moreIcons = find.byIcon(Icons.more_vert);
    if (moreIcons.evaluate().isEmpty) {
      print('âš ï¸ MenÃº de opciones no encontrado, omitiendo eliminaciÃ³n');
      return;
    }

    await tester.tap(moreIcons.first);
    await tester.pumpAndSettle();

    // Buscar opciÃ³n Eliminar
    final deleteOption = find.text('Eliminar');
    if (deleteOption.evaluate().isNotEmpty) {
      await tester.tap(deleteOption.first);
      await tester.pumpAndSettle();

      // Confirmar en diÃ¡logo
      final confirmButton = find.byType(TextButton);
      if (confirmButton.evaluate().length >= 2) {
        await tester.tap(confirmButton.last);
        await tester.pumpAndSettle(const Duration(seconds: 3));
      }

      // Verificar
      expect(find.text(email), findsNothing);
      print('âœ… Usuario eliminado exitosamente');
    }
  }

  // ============================================================================
  // GRUPOS DE PRUEBAS POR ROL
  // ============================================================================

  /// FLUJO 1: SUPER ADMINISTRADOR
  group('ğŸ” Flujo 1: Super Administrador', () {
    setUp(() async {
      await clearAuthState();
    });

    testWidgets(
      'Debe realizar login, CRUD de Instituciones y Usuarios, y logout',
      (WidgetTester tester) async {
        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  INICIANDO FLUJO: SUPER ADMINISTRADOR  â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        // Iniciar app
        app.main();
        await tester.pumpAndSettle(const Duration(seconds: 3));

        // 1. LOGIN
        print('\nâ”â”â” PASO 1: LOGIN â”â”â”');
        await loginAs(tester, 'superadmin@asistapp.com', 'Admin123!');

        // Verificar que llegÃ³ al dashboard
        final dashboardText = find.text('Dashboard');
        expect(dashboardText, findsWidgets);
        print('âœ… Dashboard cargado correctamente');

        // 2. CRUD DE INSTITUCIONES
        print('\nâ”â”â” PASO 2: CRUD DE INSTITUCIONES â”â”â”');
        final timestamp = DateTime.now().millisecondsSinceEpoch;
        final instName = 'Instituto E2E $timestamp';
        final instCode = 'IE2E-$timestamp';
        final instEmail = 'e2e.$timestamp@institucion.edu';
        final updatedInstName = '$instName (Actualizado)';

        await navigateTo(tester, 'Instituciones');

        // CREATE
        await createInstitution(
          tester,
          nombre: instName,
          codigo: instCode,
          email: instEmail,
        );

        // UPDATE
        await updateInstitution(
          tester,
          originalName: instName,
          newName: updatedInstName,
        );

        // DELETE
        await deleteInstitution(tester, institutionName: updatedInstName);

        // 3. CRUD DE USUARIOS
        print('\nâ”â”â” PASO 3: CRUD DE USUARIOS â”â”â”');
        final profEmail = 'profesor.e2e.$timestamp@asistapp.edu';

        await navigateTo(tester, 'Usuarios');

        // CREATE
        await createUser(
          tester,
          nombres: 'Profesor',
          apellidos: 'E2E Test',
          email: profEmail,
        );

        // DELETE
        await deleteUser(tester, email: profEmail);

        // 4. LOGOUT
        print('\nâ”â”â” PASO 4: LOGOUT â”â”â”');
        await performLogout(tester);

        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  âœ… FLUJO COMPLETADO EXITOSAMENTE       â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
      },
    );
  });

  /// FLUJO 2: ADMINISTRADOR DE INSTITUCIÃ“N (MULTI)
  group('ğŸ« Flujo 2: Administrador de InstituciÃ³n (Multi)', () {
    setUp(() async {
      await clearAuthState();
    });

    testWidgets(
      'Debe hacer login, seleccionar instituciÃ³n, y gestionar usuarios',
      (WidgetTester tester) async {
        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  INICIANDO FLUJO: ADMIN INSTITUCIÃ“N    â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        app.main();
        await tester.pumpAndSettle(const Duration(seconds: 3));

        // 1. LOGIN
        print('\nâ”â”â” PASO 1: LOGIN â”â”â”');
        await loginAs(tester, 'multi@asistapp.com', 'Multi123!');

        // 2. SELECCIÃ“N DE INSTITUCIÃ“N (si aplica)
        print('\nâ”â”â” PASO 2: SELECCIÃ“N DE INSTITUCIÃ“N â”â”â”');
        final institutionSelectionText = find.text('Seleccionar InstituciÃ³n');
        if (institutionSelectionText.evaluate().isNotEmpty) {
          print('â„¹ï¸ Pantalla de selecciÃ³n de instituciÃ³n encontrada');

          // Seleccionar primera instituciÃ³n
          final radioButtons = find.byType(Radio);
          if (radioButtons.evaluate().isNotEmpty) {
            await tester.tap(radioButtons.first);
            await tester.pumpAndSettle();

            // Presionar Continuar
            final continueButton = find.text('Continuar');
            if (continueButton.evaluate().isNotEmpty) {
              await tester.tap(continueButton.first);
              await tester.pumpAndSettle(const Duration(seconds: 3));
            }
          }
        } else {
          print('âœ“ No hay pantalla de selecciÃ³n, continuar...');
        }

        // 3. CRUD DE USUARIOS
        print('\nâ”â”â” PASO 3: CRUD DE USUARIOS â”â”â”');
        final timestamp = DateTime.now().millisecondsSinceEpoch;
        final estudEmail = 'estudiante.e2e.$timestamp@asistapp.edu';

        await navigateTo(tester, 'Usuarios');

        // CREATE
        await createUser(
          tester,
          nombres: 'Estudiante',
          apellidos: 'E2E Test',
          email: estudEmail,
          identificacion: 'ID-$timestamp',
          responsable: 'Responsable Test',
        );

        // DELETE
        await deleteUser(tester, email: estudEmail);

        // 4. LOGOUT
        print('\nâ”â”â” PASO 4: LOGOUT â”â”â”');
        await performLogout(tester);

        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  âœ… FLUJO COMPLETADO EXITOSAMENTE       â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
      },
    );
  });

  /// FLUJO 3: PROFESOR
  group('ğŸ‘¨â€ğŸ« Flujo 3: Profesor', () {
    setUp(() async {
      await clearAuthState();
    });

    testWidgets(
      'Debe hacer login y ver su dashboard de profesor',
      (WidgetTester tester) async {
        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  INICIANDO FLUJO: PROFESOR             â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        app.main();
        await tester.pumpAndSettle(const Duration(seconds: 3));

        // 1. LOGIN
        print('\nâ”â”â” PASO 1: LOGIN â”â”â”');
        await loginAs(tester, 'pedro.garcia@sanjose.edu', 'Prof123!');

        // 2. VERIFICAR DASHBOARD DE PROFESOR
        print('\nâ”â”â” PASO 2: VERIFICAR DASHBOARD â”â”â”');
        final dashboardText = find.text('Dashboard');
        expect(dashboardText, findsWidgets);
        print('âœ… Dashboard del profesor cargado');
        print('â„¹ï¸ Opciones disponibles en el dashboard del profesor');

        // 3. LOGOUT
        print('\nâ”â”â” PASO 3: LOGOUT â”â”â”');
        await performLogout(tester);

        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  âœ… FLUJO COMPLETADO EXITOSAMENTE       â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
      },
    );
  });

  /// FLUJO 4: ESTUDIANTE
  group('ğŸ‘¨â€ğŸ“ Flujo 4: Estudiante', () {
    setUp(() async {
      await clearAuthState();
    });

    testWidgets(
      'Debe hacer login y ver su dashboard de estudiante',
      (WidgetTester tester) async {
        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  INICIANDO FLUJO: ESTUDIANTE           â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        app.main();
        await tester.pumpAndSettle(const Duration(seconds: 3));

        // 1. LOGIN
        print('\nâ”â”â” PASO 1: LOGIN â”â”â”');
        await loginAs(tester, 'juan.perez@sanjose.edu', 'Est123!');

        // 2. VERIFICAR DASHBOARD DE ESTUDIANTE
        print('\nâ”â”â” PASO 2: VERIFICAR DASHBOARD â”â”â”');
        final dashboardText = find.text('Dashboard');
        expect(dashboardText, findsWidgets);
        print('âœ… Dashboard del estudiante cargado');

        // Buscar opciones especÃ­ficas del estudiante
        print('â„¹ï¸ Opciones disponibles en el dashboard del estudiante');

        // 3. LOGOUT
        print('\nâ”â”â” PASO 3: LOGOUT â”â”â”');
        await performLogout(tester);

        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  âœ… FLUJO COMPLETADO EXITOSAMENTE       â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
      },
    );
  });

  /// FLUJO 5: ADMIN INSTITUCIÃ“N ESPECÃFICO
  group('ğŸ‘¨â€ğŸ’¼ Flujo 5: Admin InstituciÃ³n (San JosÃ©)', () {
    setUp(() async {
      await clearAuthState();
    });

    testWidgets(
      'Debe hacer login como admin especÃ­fico de instituciÃ³n',
      (WidgetTester tester) async {
        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  INICIANDO FLUJO: ADMIN SAN JOSÃ‰       â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        app.main();
        await tester.pumpAndSettle(const Duration(seconds: 3));

        // 1. LOGIN
        print('\nâ”â”â” PASO 1: LOGIN â”â”â”');
        await loginAs(tester, 'admin@sanjose.edu', 'SanJose123!');

        // 2. VERIFICAR DASHBOARD
        print('\nâ”â”â” PASO 2: VERIFICAR DASHBOARD â”â”â”');
        final dashboardText = find.text('Dashboard');
        expect(dashboardText, findsWidgets);
        print('âœ… Dashboard del admin de instituciÃ³n cargado');

        // 3. LOGOUT
        print('\nâ”â”â” PASO 3: LOGOUT â”â”â”');
        await performLogout(tester);

        print('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
        print('â•‘  âœ… FLUJO COMPLETADO EXITOSAMENTE       â•‘');
        print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
      },
    );
  });
}
