rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return firestore.exists(/databases/(default)/documents/taskmonitoring/config) &&
             firestore.get(/databases/(default)/documents/taskmonitoring/config).data.superAdminUids.hasAny([request.auth.uid]);
    }

    function isSiteAdmin() {
      return firestore.exists(/databases/(default)/documents/taskmonitoring/users/$(request.auth.uid)) &&
             firestore.get(/databases/(default)/documents/taskmonitoring/users/$(request.auth.uid)).data.roles.hasAny(['site_admin']);
    }

    function isEmployee() {
      return firestore.exists(/databases/(default)/documents/taskmonitoring/users/$(request.auth.uid)) &&
             firestore.get(/databases/(default)/documents/taskmonitoring/users/$(request.auth.uid)).data.roles.hasAny(['employee']);
    }

    function canAccessAssignment(assignmentId) {
      return firestore.exists(/databases/(default)/documents/taskmonitoring/assignments/$(assignmentId)) &&
             firestore.get(/databases/(default)/documents/taskmonitoring/assignments/$(assignmentId)).data.userId == request.auth.uid;
    }

    // Evidence uploads
    match /taskmonitoring/evidence/{assignmentId}/{allPaths=**} {
      allow read: if isAuthenticated() &&
                   (isSuperAdmin() || isSiteAdmin() || canAccessAssignment(assignmentId));
      allow write: if isAuthenticated() &&
                    (isSuperAdmin() || isSiteAdmin() || canAccessAssignment(assignmentId)) &&
                    request.resource.size < 10 * 1024 * 1024 && // 10MB max
                    request.resource.contentType.matches('image/.*');
    }
  }
}