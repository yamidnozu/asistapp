// ============================================
// AsistApp V2 - Prisma Schema (MVP)
// Versión: 2.0.0
// Fecha: 23 de Octubre 2025
// Descripción: Esquema minimalista para MVP
// ============================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// MODELOS PRINCIPALES
// ============================================

// 1. INSTITUCIONES (Colegios)
model Institucion {
  id        String   @id @default(uuid()) @db.Uuid
  nombre    String   @db.VarChar(255)
  direccion String?  @db.Text
  telefono  String?  @db.VarChar(20)
  email     String?  @db.VarChar(255)
  activa    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  usuarioInstituciones UsuarioInstitucion[]
  periodosAcademicos   PeriodoAcademico[]
  grupos               Grupo[]
  materias             Materia[]
  horarios             Horario[]
  asistencias          Asistencia[]
  configuraciones      Configuracion?

  @@map("instituciones")
}

// 1.1. USUARIO_INSTITUCIONES (Relación muchos a muchos)
model UsuarioInstitucion {
  id               String   @id @default(uuid()) @db.Uuid
  usuarioId        String   @map("usuario_id") @db.Uuid
  institucionId    String   @map("institucion_id") @db.Uuid
  rolEnInstitucion String?  @map("rol_en_institucion") @db.VarChar(50) // Rol específico en esta institución (opcional)
  activo           Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  usuario     Usuario     @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  institucion Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, institucionId])
  @@map("usuario_instituciones")
}

// 2. USUARIOS (Admins, Profesores, Estudiantes)
model Usuario {
  id             String   @id @default(uuid()) @db.Uuid
  email          String   @unique @db.VarChar(255)
  passwordHash   String   @map("password_hash") @db.VarChar(255)
  nombres        String   @db.VarChar(255)
  apellidos      String   @db.VarChar(255)
  identificacion String?  @db.VarChar(50) // Documento de identidad (cédula, DNI, etc.)
  // Campos específicos para profesores
  titulo         String?  @db.VarChar(255)
  especialidad   String?  @db.VarChar(255)
  rol            String   @db.VarChar(50) // 'super_admin', 'admin_institucion', 'profesor', 'estudiante'
  telefono       String?  @db.VarChar(20)
  activo         Boolean  @default(true)
  tokenVersion   Int      @default(1) @map("token_version") // Para revocación rápida de tokens
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  estudiante           Estudiante?
  usuarioInstituciones UsuarioInstitucion[]
  horarios             Horario[]
  asistencias          Asistencia[]
  refreshTokens        RefreshToken[]

  @@map("usuarios")
}

// 3. ESTUDIANTES (Info adicional de estudiantes)
model Estudiante {
  id                  String   @id @default(uuid()) @db.Uuid
  usuarioId           String   @unique @map("usuario_id") @db.Uuid
  identificacion      String   @unique @db.VarChar(50) // Documento de identidad
  codigoQr            String   @unique @map("codigo_qr") @db.VarChar(255) // Para escaneo
  nombreResponsable           String?  @map("nombre_responsable") @db.VarChar(255) // Padre/Tutor
  telefonoResponsable         String?  @map("telefono_responsable") @db.VarChar(20) // WhatsApp del responsable
  telefonoResponsableVerificado Boolean  @default(false) @map("telefono_responsable_verificado")
  aceptaNotificaciones        Boolean  @default(true) @map("acepta_notificaciones")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  usuario            Usuario           @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  estudiantesGrupos  EstudianteGrupo[]
  asistencias        Asistencia[]
  logsNotificaciones LogNotificacion[]
  colaNotificaciones ColaNotificacion[]

  @@map("estudiantes")
}

// 4. PERIODOS ACADÉMICOS (Años lectivos)
model PeriodoAcademico {
  id            String   @id @default(uuid()) @db.Uuid
  institucionId String   @map("institucion_id") @db.Uuid
  nombre        String   @db.VarChar(100) // "2025", "2025-1", "2026"
  fechaInicio   DateTime @map("fecha_inicio") @db.Date
  fechaFin      DateTime @map("fecha_fin") @db.Date
  activo        Boolean  @default(true) // Solo un periodo puede estar activo a la vez por institución
  createdAt     DateTime @default(now()) @map("created_at")

  // Relaciones
  institucion Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)
  grupos      Grupo[]
  horarios    Horario[]

  @@map("periodos_academicos")
}

// 5. GRUPOS (Salones de clase)
model Grupo {
  id            String   @id @default(uuid()) @db.Uuid
  institucionId String   @map("institucion_id") @db.Uuid
  periodoId     String   @map("periodo_id") @db.Uuid
  nombre        String   @db.VarChar(50) // "10-A", "11-B"
  grado         String   @db.VarChar(10) // "10", "11"
  seccion       String?  @db.VarChar(10) // "A", "B"
  createdAt     DateTime @default(now()) @map("created_at")

  // Relaciones
  institucion       Institucion       @relation(fields: [institucionId], references: [id], onDelete: Cascade)
  periodoAcademico  PeriodoAcademico  @relation(fields: [periodoId], references: [id], onDelete: Cascade)
  estudiantesGrupos EstudianteGrupo[]
  horarios          Horario[]

  @@map("grupos")
}

// 6. MATERIAS (Asignaturas)
model Materia {
  id            String   @id @default(uuid()) @db.Uuid
  institucionId String   @map("institucion_id") @db.Uuid
  nombre        String   @db.VarChar(255) // "Matemáticas", "Español"
  codigo        String?  @db.VarChar(50) // "MAT101", "ESP201"
  createdAt     DateTime @default(now()) @map("created_at")

  // Relaciones
  institucion Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)
  horarios    Horario[]

  @@map("materias")
}

// 7. HORARIOS (Qué clase, cuándo, quién la dicta)
model Horario {
  id            String  @id @default(uuid()) @db.Uuid
  institucionId String  @map("institucion_id") @db.Uuid
  periodoId     String  @map("periodo_id") @db.Uuid
  grupoId       String  @map("grupo_id") @db.Uuid
  materiaId     String  @map("materia_id") @db.Uuid
  profesorId    String? @map("profesor_id") @db.Uuid

  // Días de la semana (1=Lunes, 7=Domingo)
  diaSemana Int // 1=Lunes, 2=Martes, ..., 7=Domingo

  // Hora de inicio y fin
  horaInicio String @map("hora_inicio") @db.VarChar(8)
  horaFin    String @map("hora_fin") @db.VarChar(8)

  createdAt DateTime @default(now()) @map("created_at")

  // Relaciones
  institucion      Institucion      @relation(fields: [institucionId], references: [id], onDelete: Cascade)
  periodoAcademico PeriodoAcademico @relation(fields: [periodoId], references: [id], onDelete: Cascade)
  grupo            Grupo            @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  materia          Materia          @relation(fields: [materiaId], references: [id], onDelete: Cascade)
  profesor         Usuario?         @relation(fields: [profesorId], references: [id], onDelete: SetNull)
  asistencias      Asistencia[]

  @@map("horarios")
}

// 8. ESTUDIANTES_GRUPOS (Relación muchos a muchos)
model EstudianteGrupo {
  id           String   @id @default(uuid()) @db.Uuid
  estudianteId String   @map("estudiante_id") @db.Uuid
  grupoId      String   @map("grupo_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  // Relaciones
  estudiante Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  grupo      Grupo      @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  @@map("estudiantes_grupos")
}

// 9. ASISTENCIAS (Registro de asistencia por clase)
model Asistencia {
  id     String   @id @default(uuid()) @db.Uuid
  fecha  DateTime @default(now())
  estado String   @default("PRESENTE") // PRESENTE, AUSENTE, TARDANZA, JUSTIFICADO

  horarioId     String @map("horario_id") @db.Uuid
  estudianteId  String @map("estudiante_id") @db.Uuid
  profesorId    String @map("profesor_id") @db.Uuid
  institucionId String @map("institucion_id") @db.Uuid

  horaRegistro  DateTime @default(now()) @map("hora_registro") // Hora exacta del registro
  tipoRegistro  String   @default("MANUAL") @map("tipo_registro") // MANUAL, QR, AUTOMATICO
  observaciones String?  @db.Text // Notas adicionales

  horario     Horario     @relation(fields: [horarioId], references: [id])
  estudiante  Estudiante  @relation(fields: [estudianteId], references: [id])
  profesor    Usuario     @relation(fields: [profesorId], references: [id])
  institucion Institucion @relation(fields: [institucionId], references: [id])

  @@unique([horarioId, estudianteId, fecha]) // Un estudiante solo puede tener un registro por clase al día
  @@map("asistencias")

  colaNotificaciones ColaNotificacion[]
}

// 10. CONFIGURACIONES (Ajustes por institución)
model Configuracion {
  id            String @id @default(uuid()) @db.Uuid
  institucionId String @unique @map("institucion_id") @db.Uuid

  // Notificaciones WhatsApp
  notificacionesActivas    Boolean @default(false) @map("notificaciones_activas")
  canalNotificacion        String  @default("NONE") @map("canal_notificacion") // 'WHATSAPP', 'SMS', 'NONE'
  modoNotificacionAsistencia String  @default("MANUAL_ONLY") @map("modo_notificacion_asistencia") // 'INSTANT', 'END_OF_DAY', 'MANUAL_ONLY'
  horaDisparoNotificacion  String? @map("hora_disparo_notificacion") @db.VarChar(8) // "18:00:00"
  notificarAusenciaTotalDiaria Boolean @default(false) @map("notificar_ausencia_total_diaria") // Notificar si falta a todas las clases del día

  // Configuración de horarios (24 horas disponibles)
  horaInicioClases String @default("00:00:00") @map("hora_inicio_clases") @db.VarChar(8)
  horaFinClases    String @default("23:59:59") @map("hora_fin_clases") @db.VarChar(8)

  // Días laborales (JSON array: [1,2,3,4,5] = Lunes a Viernes)
  diasLaborales Json @default("[1,2,3,4,5]") @map("dias_laborales")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  institucion Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)

  @@map("configuraciones")
}

// 11. LOGS_NOTIFICACIONES (Historial de notificaciones enviadas)
model LogNotificacion {
  id              String   @id @default(uuid()) @db.Uuid
  estudianteId    String   @map("estudiante_id") @db.Uuid
  telefonoDestino String   @map("telefono_destino") @db.VarChar(20)
  mensaje         String   @db.Text
  proveedor       String   @default("WHATSAPP") @db.VarChar(50) // 'WHATSAPP', 'SMS', 'EMAIL'
  costo           Float?   @default(0.0)
  providerMessageId String? @map("provider_message_id") @db.VarChar(255) // ID del mensaje en el proveedor
  rawResponse     Json?    @map("raw_response") // Respuesta completa del proveedor
  fechaEnvio      DateTime @default(now()) @map("fecha_envio")
  exitoso         Boolean  @default(false)
  errorMensaje    String?  @map("error_mensaje") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  // Relaciones
  estudiante Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)

  @@map("logs_notificaciones")
}

// 13. COLA_NOTIFICACIONES (Para envíos asíncronos o batch)
model ColaNotificacion {
  id             String   @id @default(uuid()) @db.Uuid
  estudianteId   String   @map("estudiante_id") @db.Uuid
  asistenciaId   String?  @map("asistencia_id") @db.Uuid // Opcional, si está ligada a una falta específica
  estado         String   @default("PENDING") @db.VarChar(20) // 'PENDING', 'PROCESSING', 'SENT', 'FAILED', 'DEAD_LETTER'
  programadoPara DateTime @default(now()) @map("programado_para")
  intentos       Int      @default(0)
  maxIntentos    Int      @default(3) @map("max_intentos")
  ultimoError    String?  @map("ultimo_error") @db.Text
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  estudiante Estudiante  @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  asistencia Asistencia? @relation(fields: [asistenciaId], references: [id], onDelete: SetNull)

  @@map("cola_notificaciones")
}

// 12. REFRESH TOKENS (Para autenticación JWT)
model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  usuarioId String   @map("usuario_id") @db.Uuid
  token     String   @unique @db.Text // El refresh token hasheado
  expiresAt DateTime @map("expires_at") // Fecha de expiración
  revoked   Boolean  @default(false) // Si fue revocado
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}
