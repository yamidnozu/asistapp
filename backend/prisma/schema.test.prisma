// Configuración de Prisma para pruebas con SQLite
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./test.db"
}

// ============================================
// MODELOS PRINCIPALES (Versión SQLite para tests)
// ============================================

// 1. INSTITUCIONES (Colegios)
model Institucion {
  id        String   @id @default(uuid())
  nombre    String
  codigo    String   @unique
  direccion String?
  telefono  String?
  email     String?
  activa    Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  usuarioInstituciones UsuarioInstitucion[]
  periodosAcademicos   PeriodoAcademico[]
  grupos               Grupo[]
  materias             Materia[]
  horarios             Horario[]
  configuraciones      Configuracion?

  @@map("instituciones")
}

// 1.1. USUARIO_INSTITUCIONES (Relación muchos a muchos)
model UsuarioInstitucion {
  id            String   @id @default(uuid())
  usuarioId     String   @map("usuario_id")
  institucionId String   @map("institucion_id")
  rolEnInstitucion String? @map("rol_en_institucion")
  activo        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  usuario     Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  institucion Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)

  @@unique([usuarioId, institucionId])
  @@map("usuario_instituciones")
}

// 2. USUARIOS (Admins, Profesores, Estudiantes)
model Usuario {
  id             String      @id @default(uuid())
  email          String      @unique
  passwordHash   String      @map("password_hash")
  nombres        String
  apellidos      String
  rol            String
  telefono       String?
  activo         Boolean     @default(true)
  tokenVersion   Int         @default(1) @map("token_version")
  createdAt      DateTime    @default(now()) @map("created_at")
  updatedAt      DateTime    @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  estudiante          Estudiante?
  usuarioInstituciones UsuarioInstitucion[]
  horarios            Horario[]
  asistencias         Asistencia[]
  refreshTokens       RefreshToken[]

  @@map("usuarios")
}

// 3. ESTUDIANTES (Info adicional de estudiantes)
model Estudiante {
  id                   String   @id @default(uuid())
  usuarioId            String   @unique @map("usuario_id")
  identificacion       String   @unique
  codigoQr             String   @unique @map("codigo_qr")
  nombreResponsable    String?  @map("nombre_responsable")
  telefonoResponsable  String?  @map("telefono_responsable")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  usuario              Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  estudiantesGrupos    EstudianteGrupo[]
  asistencias          Asistencia[]
  logsNotificaciones   LogNotificacion[]

  @@map("estudiantes")
}

// 4. PERIODOS ACADÉMICOS (Años lectivos)
model PeriodoAcademico {
  id            String      @id @default(uuid())
  institucionId String      @map("institucion_id")
  nombre        String
  fechaInicio   DateTime    @map("fecha_inicio")
  fechaFin      DateTime    @map("fecha_fin")
  activo        Boolean     @default(true)
  createdAt     DateTime    @default(now()) @map("created_at")

  // Relaciones
  institucion   Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)
  grupos        Grupo[]
  horarios      Horario[]

  @@map("periodos_academicos")
}

// 5. GRUPOS (Salones de clase)
model Grupo {
  id             String   @id @default(uuid())
  institucionId  String   @map("institucion_id")
  periodoId      String   @map("periodo_id")
  nombre         String
  grado          String
  seccion        String?
  createdAt      DateTime @default(now()) @map("created_at")

  // Relaciones
  institucion        Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)
  periodoAcademico   PeriodoAcademico @relation(fields: [periodoId], references: [id], onDelete: Cascade)
  estudiantesGrupos  EstudianteGrupo[]
  horarios           Horario[]
  asistencias        Asistencia[]

  @@map("grupos")
}

// 6. MATERIAS (Asignaturas)
model Materia {
  id            String   @id @default(uuid())
  institucionId String   @map("institucion_id")
  nombre        String
  codigo        String?
  createdAt     DateTime @default(now()) @map("created_at")

  // Relaciones
  institucion   Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)
  horarios      Horario[]

  @@map("materias")
}

// 7. HORARIOS (Qué clase, cuándo, quién la dicta)
model Horario {
  id            String   @id @default(uuid())
  institucionId String   @map("institucion_id")
  periodoId     String   @map("periodo_id")
  grupoId       String   @map("grupo_id")
  materiaId     String   @map("materia_id")
  profesorId    String?  @map("profesor_id")

  diaSemana     Int
  horaInicio    String @map("hora_inicio")
  horaFin       String @map("hora_fin")

  createdAt     DateTime @default(now()) @map("created_at")

  // Relaciones
  institucion      Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)
  periodoAcademico PeriodoAcademico @relation(fields: [periodoId], references: [id], onDelete: Cascade)
  grupo            Grupo @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  materia          Materia @relation(fields: [materiaId], references: [id], onDelete: Cascade)
  profesor         Usuario? @relation(fields: [profesorId], references: [id], onDelete: SetNull)
  asistencias      Asistencia[]

  @@map("horarios")
}

// 8. ESTUDIANTES_GRUPOS (Relación muchos a muchos)
model EstudianteGrupo {
  id           String    @id @default(uuid())
  estudianteId String    @map("estudiante_id")
  grupoId      String    @map("grupo_id")
  createdAt    DateTime  @default(now()) @map("created_at")

  // Relaciones
  estudiante   Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  grupo        Grupo @relation(fields: [grupoId], references: [id], onDelete: Cascade)

  @@map("estudiantes_grupos")
}

// 9. ASISTENCIAS (Registro de asistencia por clase)
model Asistencia {
  id            String   @id @default(uuid())
  estudianteId  String   @map("estudiante_id")
  horarioId     String   @map("horario_id")
  grupoId       String   @map("grupo_id")
  profesorId    String?  @map("profesor_id")

  fecha         DateTime
  horaRegistro  DateTime @default(now()) @map("hora_registro")
  tipoRegistro  String   @default("qr") @map("tipo_registro")
  observaciones String?
  createdAt     DateTime @default(now()) @map("created_at")

  // Relaciones
  estudiante    Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  horario       Horario @relation(fields: [horarioId], references: [id], onDelete: Cascade)
  grupo         Grupo @relation(fields: [grupoId], references: [id], onDelete: Cascade)
  profesor      Usuario? @relation(fields: [profesorId], references: [id], onDelete: SetNull)

  @@map("asistencias")
}

// 10. CONFIGURACIONES (Ajustes por institución)
model Configuracion {
  id                   String   @id @default(uuid())
  institucionId        String   @unique @map("institucion_id")

  notificacionesActivas Boolean  @default(false) @map("notificaciones_activas")
  modoNotificacion      String   @default("diaria") @map("modo_notificacion")
  horaNotificacion      String   @default("18:00:00") @map("hora_notificacion")
  umbralFaltas          Int      @default(3) @map("umbral_faltas")
  horaInicioClases      String   @default("07:00:00") @map("hora_inicio_clases")
  horaFinClases         String   @default("15:00:00") @map("hora_fin_clases")
  diasLaborales         String   @default("[1,2,3,4,5]") @map("dias_laborales")

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  institucion           Institucion @relation(fields: [institucionId], references: [id], onDelete: Cascade)

  @@map("configuraciones")
}

// 11. LOGS_NOTIFICACIONES (Historial de notificaciones enviadas)
model LogNotificacion {
  id              String   @id @default(uuid())
  estudianteId    String   @map("estudiante_id")
  telefonoDestino String   @map("telefono_destino")
  mensaje         String
  fechaEnvio      DateTime @default(now()) @map("fecha_envio")
  exitoso         Boolean  @default(false)
  errorMensaje    String?  @map("error_mensaje")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relaciones
  estudiante      Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)

  @@map("logs_notificaciones")
}

// 12. REFRESH TOKENS (Para autenticación JWT)
model RefreshToken {
  id            String    @id @default(uuid())
  usuarioId     String    @map("usuario_id")
  token         String    @unique
  expiresAt     DateTime  @map("expires_at")
  revoked       Boolean   @default(false)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relaciones
  usuario       Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}