name: Deploy to VPS

on:
  push:
    branches:
      - main  # Cambia a 'master' si usas master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      # Non-secret configuration (set defaults here). Modify these if needed.
      DB_HOST: 'db'
      DB_PORT: '5433'
      DB_USER: 'arroz'
      DB_NAME: 'asistapp'
      API_BASE_URL: 'http://31.220.104.130:3002'
      PORT: '3002'
      HOST: '0.0.0.0'
      LOG_LEVEL: 'info'
      JWT_EXPIRES_IN: '24h'
      FIREBASE_PROJECT_ID: ''

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Complete VPS Setup (nginx, SSL, backend)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        envs: DOMAIN,EMAIL,PORT,DB_HOST,DB_PORT,DB_USER,DB_PASS,DB_NAME,JWT_SECRET,JWT_EXPIRES_IN,LOG_LEVEL,API_BASE_URL
        script: |
          set -euo pipefail
          
          echo "=== Iniciando despliegue en VPS ==="
          echo "Fecha: $(date)"
          echo "Usuario: $(whoami)"
          echo "Directorio actual: $(pwd)"
          
          # Clone/update repository
          echo "→ Clonando/actualizando repositorio..."
          if [ ! -d "/opt/asistapp" ]; then
            git clone https://github.com/${{ github.repository }} /opt/asistapp
          else
            cd /opt/asistapp
            # Reset any local changes to ensure clean state
            git reset --hard HEAD
            git pull origin main
          fi
          
          # Export all variables for the setup script
          echo "→ Configurando variables de entorno..."
          export DOMAIN='${{ secrets.DOMAIN }}'
          export EMAIL='${{ secrets.EMAIL }}'
          export PORT='${{ env.PORT }}'
          export DB_HOST='${{ env.DB_HOST }}'
          export DB_PORT='${{ env.DB_PORT }}'
          export DB_USER='${{ env.DB_USER }}'
          export DB_PASS='${{ secrets.DB_PASS }}'
          export DB_NAME='${{ env.DB_NAME }}'
          export JWT_SECRET='${{ secrets.JWT_SECRET }}'
          export JWT_EXPIRES_IN='${{ env.JWT_EXPIRES_IN }}'
          export LOG_LEVEL='${{ env.LOG_LEVEL }}'
          export REPO_PATH='/opt/asistapp'
          
          echo "✓ Variables configuradas"
          echo "DOMAIN: '$DOMAIN'"
          echo "EMAIL: '$EMAIL'"
          echo "DB_PASS: '[REDACTED]'"
          echo "JWT_SECRET: '[REDACTED]'"
          
          # Verify script exists and is executable
          echo "→ Verificando script de setup..."
          if [ ! -f "/opt/asistapp/scripts/setup_vps_complete.sh" ]; then
            echo "ERROR: Script setup_vps_complete.sh no encontrado" >&2
            exit 1
          fi
          
          chmod +x /opt/asistapp/scripts/setup_vps_complete.sh
          echo "✓ Script verificado y ejecutable"
          
          # Run complete setup script
          echo "→ Ejecutando script de setup completo..."
          cd /opt/asistapp
          bash -x /opt/asistapp/scripts/setup_vps_complete.sh

    # Note: El script setup_vps_complete.sh ahora maneja todo el proceso de setup y deployment