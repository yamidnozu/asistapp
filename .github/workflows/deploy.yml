name: Deploy to VPS

on:
  push:
    branches:
      - main  # Cambia a 'master' si usas master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare .env and deploy on VPS (build-on-vps)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -euo pipefail
          # Clone or pull the repository
          if [ ! -d "/opt/asistapp" ]; then
            git clone https://github.com/${{ github.repository }} /opt/asistapp
          else
            cd /opt/asistapp && git pull origin main || true
          fi

          # Create backend/.env from secrets passed by GitHub Actions (use printf to avoid heredoc issues)
          printf '%s=%s\n' "DB_HOST" "${{ secrets.DB_HOST }}" > /opt/asistapp/backend/.env
          printf '%s=%s\n' "DB_PORT" "${{ secrets.DB_PORT }}" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "DB_USER" "${{ secrets.DB_USER }}" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "DB_PASS" "${{ secrets.DB_PASS }}" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "DB_NAME" "${{ secrets.DB_NAME }}" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "DATABASE_URL" "postgresql://${{ secrets.DB_USER }}:${{ secrets.DB_PASS }}@${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}/${{ secrets.DB_NAME }}?schema=public" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "JWT_SECRET" "${{ secrets.JWT_SECRET }}" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "JWT_EXPIRES_IN" "${{ secrets.JWT_EXPIRES_IN }}" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "PORT" "${{ secrets.PORT }}" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "HOST" "${{ secrets.HOST }}" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "NODE_ENV" "production" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "LOG_LEVEL" "${{ secrets.LOG_LEVEL }}" >> /opt/asistapp/backend/.env
          printf '%s=%s\n' "FIREBASE_PROJECT_ID" "${{ secrets.FIREBASE_PROJECT_ID }}" >> /opt/asistapp/backend/.env

          # ensure permissions
          chown root:root /opt/asistapp/backend/.env
          chmod 600 /opt/asistapp/backend/.env

          # Run deployment script on the VPS (build and up)
          cd /opt/asistapp
          ./scripts/deploy_on_vps.sh --build

    # (All deploy steps are handled in the 'Prepare .env and deploy on VPS' step above.)